# äº¤äº’è®°å½•

## 1. åˆ›å»º CLAUDE.md æ–‡ä»¶

### æé—®
è¯·åˆ†æè¿™ä¸ªä»£ç åº“å¹¶åˆ›å»ºä¸€ä¸ª CLAUDE.md æ–‡ä»¶,ç”¨äºæŒ‡å¯¼æœªæ¥çš„ Claude Code å®ä¾‹åœ¨æ­¤ä»“åº“ä¸­å·¥ä½œã€‚

### å›ç­”
å·²æˆåŠŸåˆ†æ TienKung-Lab ä»£ç åº“å¹¶åˆ›å»ºäº† `/home/ykj/project/TienKung-Lab/CLAUDE.md` æ–‡ä»¶ã€‚

è¯¥æ–‡ä»¶åŒ…å«ä»¥ä¸‹å†…å®¹:

1. **é¡¹ç›®æ¦‚è¿°**
   - TienKung-Lab æ˜¯åŸºäº IsaacLab çš„å…¨å°ºå¯¸äººå½¢æœºå™¨äººå¼ºåŒ–å­¦ä¹ è¿åŠ¨æ§åˆ¶æ¡†æ¶
   - æŠ€æœ¯æ ˆ: IsaacSim 4.5.0, IsaacLab 2.1.0, RSL_RL 2.3.1, Python 3.10, MuJoCo 3.3.2

2. **å¸¸ç”¨å‘½ä»¤**
   - å®‰è£…ä¸è®¾ç½®å‘½ä»¤
   - è®­ç»ƒå‘½ä»¤ (walk/run ä»»åŠ¡)
   - æµ‹è¯•ä¸å¯è§†åŒ–å‘½ä»¤ (å¸¦/ä¸å¸¦ä¼ æ„Ÿå™¨)
   - Sim2Sim éªŒè¯å‘½ä»¤
   - TensorBoard å’Œä»£ç æ ¼å¼åŒ–å‘½ä»¤

3. **æ¶æ„è®¾è®¡**
   - æ ¸å¿ƒç»„ä»¶å±‚æ¬¡ç»“æ„:
     - ä»»åŠ¡æ³¨å†Œç³»ç»Ÿ (`task_registry.py`)
     - åŸºç¡€ç¯å¢ƒæ¶æ„ (`BaseEnv`, `BaseEnvCfg`)
     - TienKung ç¯å¢ƒå®ç° (walk/run é…ç½®)
     - å¥–åŠ±ä¸æ„ŸçŸ¥ç³»ç»Ÿ (MDP å¥–åŠ±ã€ç›¸æœºã€æ¿€å…‰é›·è¾¾)
     - RSL-RL ç®—æ³• (PPO, AMP-PPO)

   - åŠ¨ä½œé‡å®šå‘å·¥ä½œæµ:
     - æ•°æ®é›†ç»“æ„ (`motion_visualization/`, `motion_amp_expert/`)
     - æ•°æ®è½¬æ¢æµç¨‹ (GMR â†’ å¯è§†åŒ–æ•°æ® â†’ ä¸“å®¶æ•°æ®)

   - å…³é”®é…ç½®å‚æ•°:
     - æ­¥æ€å‚æ•° (å‘¨æœŸã€ç¦»åœ°æ¯”ä¾‹ã€ç›¸ä½åç§»)
     - å¥–åŠ±æƒé‡
     - ä»¿çœŸå‚æ•° (physics_dt: 0.005s, control freq: 50Hz)

   - å¯¼å‡ºä¸éƒ¨ç½²:
     - è‡ªåŠ¨å¯¼å‡º JIT å’Œ ONNX æ ¼å¼
     - åŒ…å«è§‚å¯Ÿå½’ä¸€åŒ–å™¨

   - ä¸ IsaacLab çš„é›†æˆæ–¹å¼

4. **å¼€å‘æ³¨æ„äº‹é¡¹**
   - å¸¦ä¼ æ„Ÿå™¨ä»»åŠ¡çš„è‡ªåŠ¨ç›¸æœºæ¸²æŸ“
   - ç­–ç•¥è‡ªåŠ¨å¯¼å‡ºæœºåˆ¶
   - æ—¥å¿—è·¯å¾„ç»“æ„
   - Conda ç¯å¢ƒä½¿ç”¨å»ºè®®

æ–‡ä»¶ä½ç½®: `/home/ykj/project/TienKung-Lab/CLAUDE.md`

## 2. G1 é‡å®šå‘æ•ˆæœä¸ä½³çš„é—®é¢˜æ’æŸ¥ä¸è§£å†³

### æé—®
ç°åœ¨ç”¨çš„ g1 é‡å®šå‘æ˜¾ç¤ºå‡ºæ¥çš„æ•ˆæœä¸å¥½,ç°åœ¨åœ¨æ’æŸ¥åŸå› ,æˆ‘è§‰å¾—å¯èƒ½æ˜¯å› ä¸ºåœ¨ gmr ä¸­æˆ‘ç”¨çš„æ˜¯ g1_mocap_29dof.xml è€Œåœ¨è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ g1_29dof.xml çš„åŸå› ,ä½†æ˜¯ gmr ä¸­æ²¡æœ‰ mocap ç‰ˆæœ¬ xml çš„ urdf æ–‡ä»¶,è¿™ä¸ªé¡¹ç›®åœ¨å“ªé‡Œè¦ç”¨åˆ° urdf æ–‡ä»¶,èƒ½ä¸èƒ½æ”¹ä¸ºä½¿ç”¨ mocap ç‰ˆæœ¬çš„ xml è¿›è¡Œ Motion Visualization è¿™ä¸€æ­¥,è°ƒè¯•åˆ°å¯ä»¥æ­£å¸¸æ‰§è¡Œå¹¶æ˜¾ç¤ºå¯è§†åŒ–ç•Œé¢è®©æˆ‘æ£€æŸ¥é‡å®šå‘ç»“æœ,ç”¨ dance1_2.txt æ¥å¯è§†åŒ–ã€‚

### å›ç­”

#### é—®é¢˜åˆ†æ
1. **IsaacLab ä½¿ç”¨çš„æ˜¯ USD æ–‡ä»¶,ä¸æ˜¯ XML**
   - åœ¨ `legged_lab/assets/g1_29dof/g1_29dof.py:36` ä¸­,é¡¹ç›®ä½¿ç”¨ `g1_29dof.usd` æ–‡ä»¶
   - XML æ–‡ä»¶ (`g1_29dof.xml` å’Œ `g1_mocap_29dof.xml`) æ˜¯ä¸º MuJoCo/GMR å‡†å¤‡çš„,ä¸åœ¨ IsaacLab ä¸­ä½¿ç”¨

2. **g1_29dof.xml å’Œ g1_mocap_29dof.xml çš„ä¸»è¦å·®å¼‚**
   - **å…³èŠ‚èŒƒå›´é™åˆ¶ä¸åŒ**: mocap ç‰ˆæœ¬çš„å…³èŠ‚èŒƒå›´æ›´å—é™(å¦‚ hip_pitch ä» [-2.5307, 2.8798] æ”¹ä¸º [-1.57, 1.57])
   - **æ¨¡å‹å‘½å**: `g1_29dof` vs `g1_mocap`
   - **ç½‘æ ¼æ–‡ä»¶å**: æŸäº› link ä½¿ç”¨äº† `_rev_1_0` åç¼€çš„ç½‘æ ¼æ–‡ä»¶
   - **é¢å¤–çš„ body**: mocap ç‰ˆæœ¬æ·»åŠ äº† `left_toe_link` å’Œ `pelvis_contour_link`
   - **å…³èŠ‚ç±»å‹**: `floating_base_joint` (type="free") vs `pelvis` (freejoint)

3. **dance1_2.txt æ–‡ä»¶ä½ç½®**
   - åŸå§‹ä½ç½®: `legged_lab/envs/tienkung/datasets/motion_visualization/dance1_2.txt`
   - éœ€è¦å¤åˆ¶åˆ°: `legged_lab/envs/g1/datasets/motion_visualization/dance1_2.txt`

#### è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤ 1: å¤åˆ¶ dance1_2.txt åˆ° G1 æ•°æ®é›†ç›®å½•**
```bash
mkdir -p legged_lab/envs/g1/datasets/motion_visualization
cp legged_lab/envs/tienkung/datasets/motion_visualization/dance1_2.txt \
   legged_lab/envs/g1/datasets/motion_visualization/
```

**æ­¥éª¤ 2: ä¿®æ”¹ G1 ç¯å¢ƒé…ç½®**
å·²ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ä½¿ç”¨ dance1_2.txt:
- `legged_lab/envs/g1/g1_walk_cfg.py:164`
- `legged_lab/envs/g1/g1_run_cfg.py:164`

ä¿®æ”¹å†…å®¹:
```python
amp_motion_files_display = ["legged_lab/envs/g1/datasets/motion_visualization/dance1_2.txt"]
```

**æ­¥éª¤ 3: éªŒè¯é…ç½®**
è¿è¡Œæµ‹è¯•è„šæœ¬ `test_g1_dance_config.py` ç¡®è®¤:
- âœ… dance1_2.txt æ–‡ä»¶å­˜åœ¨
- âœ… JSON æ ¼å¼æ­£ç¡®
- âœ… åŒ…å« 3944 å¸§æ•°æ®
- âœ… æ¯å¸§ 70 ç»´æ•°æ®
- âœ… ä¸¤ä¸ªé…ç½®æ–‡ä»¶éƒ½å·²æ›´æ–°

**æ­¥éª¤ 4: è¿è¡Œå¯è§†åŒ–**
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ G1 åŠ¨ä½œå¯è§†åŒ–:
```bash
# æ–¹å¼ 1: ä½¿ç”¨ IsaacLab è„šæœ¬ (æ¨è)
/home/ykj/tool/IsaacLab/isaaclab.sh -p legged_lab/scripts/play_amp_animation.py \
    --task=g1_walk --num_envs=1

# æ–¹å¼ 2: ç›´æ¥ä½¿ç”¨ Python (éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡)
LD_LIBRARY_PATH=/home/ykj/miniconda3/envs/TieKung/lib/python3.10/site-packages/omni:$LD_LIBRARY_PATH \
PYTHONPATH=/home/ykj/miniconda3/envs/TieKung/lib/python3.10/site-packages/omni/kernel/py:$PYTHONPATH \
conda run -n TieKung python legged_lab/scripts/play_amp_animation.py --task=g1_walk --num_envs=1

# æ–¹å¼ 3: ä½¿ç”¨ g1_run ä»»åŠ¡
/home/ykj/tool/IsaacLab/isaaclab.sh -p legged_lab/scripts/play_amp_animation.py \
    --task=g1_run --num_envs=1
```

#### é‡è¦å‘ç°

1. **XML vs USD çš„åŒºåˆ«**
   - IsaacSim/IsaacLab ä½¿ç”¨ USD (Universal Scene Description) æ ¼å¼
   - GMR ä½¿ç”¨ MuJoCo XML æ ¼å¼
   - ä¸¤è€…çš„å·®å¼‚ä¸ä¼šå½±å“ IsaacLab çš„å¯è§†åŒ–,å› ä¸º IsaacLab ä¸è¯»å– XML æ–‡ä»¶

2. **åŠ¨ä½œæ•°æ®æ ¼å¼**
   - `gmr_data_conversion.py` å°† GMR è¾“å‡ºçš„ PKL æ–‡ä»¶è½¬æ¢ä¸ºé¡¹ç›®æ‰€éœ€çš„ TXT æ ¼å¼
   - æ ¼å¼åŒ…å«: `[root_pos(3), euler_angles(3), dof_pos(26), root_lin_vel(3), root_ang_vel(3), dof_vel(26)]`
   - G1 29DOF: 26 ä¸ªå¯æ§å…³èŠ‚ (6 è…¿éƒ¨ Ã— 2 + 3 è…°éƒ¨ + 4 æ‰‹è‡‚ Ã— 2 + 3 æ‰‹è…• Ã— 2)

3. **å¯è§†åŒ–æµç¨‹**
   - `play_amp_animation.py` ä½¿ç”¨ `AMPLoaderDisplay` åŠ è½½ TXT æ–‡ä»¶
   - `G1Env.visualize_motion()` æ–¹æ³•æ ¹æ®æ—¶é—´æˆ³è®¾ç½®æœºå™¨äººçŠ¶æ€
   - æ•°æ®æ˜ å°„: ä» TXT æ ¼å¼çš„ dof_pos/vel æ˜ å°„åˆ° G1 çš„ç‰¹å®šå…³èŠ‚é¡ºåº

#### ä¸‹ä¸€æ­¥å»ºè®®

1. **æ£€æŸ¥é‡å®šå‘è´¨é‡**
   - åœ¨ IsaacSim å¯è§†åŒ–ç•Œé¢ä¸­è§‚å¯Ÿ dance1_2 åŠ¨ä½œ
   - æ£€æŸ¥å…³èŠ‚è§’åº¦æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…
   - è§‚å¯Ÿæ˜¯å¦æœ‰ä¸è‡ªç„¶çš„å§¿æ€æˆ–æŠ–åŠ¨

2. **å¦‚æœæ•ˆæœä»ä¸ç†æƒ³**
   - å¯èƒ½éœ€è¦è°ƒæ•´ GMR çš„é‡å®šå‘å‚æ•°
   - æ£€æŸ¥ G1 çš„å…³èŠ‚é™åˆ¶æ˜¯å¦ä¸ mocap ç‰ˆæœ¬ä¸€è‡´
   - è€ƒè™‘åœ¨ `g1_29dof.py` ä¸­è°ƒæ•´å…³èŠ‚èŒƒå›´é™åˆ¶

3. **ç”Ÿæˆ AMP è®­ç»ƒæ•°æ®**
   ```bash
   /home/ykj/tool/IsaacLab/isaaclab.sh -p legged_lab/scripts/play_amp_animation.py \
       --task=g1_walk --num_envs=1 \
       --save_path legged_lab/envs/g1/datasets/motion_amp_expert/dance1_2.txt
   ```

#### ç›¸å…³æ–‡ä»¶ä½ç½®
- G1 USD é…ç½®: `legged_lab/assets/g1_29dof/g1_29dof.py:36`
- G1 ç¯å¢ƒç±»: `legged_lab/envs/g1/g1_env.py`
- å¯è§†åŒ–è„šæœ¬: `legged_lab/scripts/play_amp_animation.py`
- æ•°æ®è½¬æ¢è„šæœ¬: `legged_lab/scripts/gmr_data_conversion.py`
- Walk é…ç½®: `legged_lab/envs/g1/g1_walk_cfg.py:164`
- Run é…ç½®: `legged_lab/envs/g1/g1_run_cfg.py:164`

---

## 3. visualize_motion å®ç°åŸç†

### æé—®
visualize_motionè¿™ä¸€æ­¥æ˜¯æ€ä¹ˆå®ç°çš„,æ€ä¹ˆè¯»å–çš„æ•°æ®ç„¶åç”¨çš„å“ªé‡Œçš„æœºå™¨äººé…ç½®æ–‡ä»¶è¿›è¡Œå¯è§†åŒ–

### å›ç­”

#### æ•´ä½“å·¥ä½œæµç¨‹

`visualize_motion` æ˜¯ä¸€ä¸ªç”¨äºåœ¨ IsaacSim ä¸­æ’­æ”¾åŠ¨ä½œæ•æ‰æ•°æ®çš„å¯è§†åŒ–ç³»ç»Ÿ,ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:

**1. æ•°æ®åŠ è½½é˜¶æ®µ (åˆå§‹åŒ–æ—¶)**

åœ¨ç¯å¢ƒåˆå§‹åŒ–æ—¶ (`legged_lab/envs/tienkung/tienkung_env.py:123-126`):
```python
self.amp_loader_display = AMPLoaderDisplay(
    motion_files=self.cfg.amp_motion_files_display,
    device=self.device,
    time_between_frames=self.physics_dt
)
self.motion_len = self.amp_loader_display.trajectory_num_frames[0]
```

**2. æ•°æ®æ–‡ä»¶é…ç½®**

åŠ¨ä½œæ•°æ®æ–‡ä»¶åœ¨å„ä¸ªä»»åŠ¡é…ç½®ä¸­å®šä¹‰,ä¾‹å¦‚åœ¨ `legged_lab/envs/tienkung/walk_cfg.py:164`:
```python
amp_motion_files_display = ["legged_lab/envs/tienkung/datasets/motion_visualization/walk.txt"]
```

**3. æ•°æ®è¯»å–ä¸è§£æ** (`rsl_rl/rsl_rl/utils/motion_loader_for_display.py`)

`AMPLoaderDisplay` ç±»è´Ÿè´£è¯»å–å’Œè§£æåŠ¨ä½œæ•°æ®:
- **æ–‡ä»¶æ ¼å¼**: JSON æ ¼å¼çš„ TXT æ–‡ä»¶,åŒ…å«:
  - `LoopMode`: å¾ªç¯æ¨¡å¼ ("Wrap")
  - `FrameDuration`: å¸§é—´éš”æ—¶é—´ (é€šå¸¸ 1/30 ç§’)
  - `EnableCycleOffsetPosition/Rotation`: å¾ªç¯åç§»è®¾ç½®
  - `MotionWeight`: åŠ¨ä½œæƒé‡
  - `Frames`: åŠ¨ä½œå¸§æ•°ç»„

- **æ•°æ®ç»“æ„** (motion_loader_for_display.py:68-79):
  ```python
  motion_data = np.array(motion_json["Frames"])
  # æå–å…³èŠ‚ä½ç½®å’Œé€Ÿåº¦æ•°æ® (å‰52ç»´)
  self.trajectories_full.append(
      torch.tensor(motion_data[:, :AMPLoaderDisplay.JOINT_VEL_END_IDX], ...)
  )
  ```

- **æ•°æ®ç»´åº¦**:
  - `JOINT_POS_SIZE = 26`: å…³èŠ‚ä½ç½®ç»´åº¦
  - `JOINT_VEL_SIZE = 26`: å…³èŠ‚é€Ÿåº¦ç»´åº¦
  - æ€»å…± 52 ç»´ (26 ä½ç½® + 26 é€Ÿåº¦)

**4. å¯è§†åŒ–æ‰§è¡Œ** (`legged_lab/scripts/play_amp_animation.py:54-87`)

ä¸»å¾ªç¯è°ƒç”¨ `visualize_motion`:
```python
while simulation_app.is_running():
    while True:
        time = (frame_cnt % (env.motion_len)) * (1.0/args_cli.fps)
        frame = env.visualize_motion(time)  # æ ¸å¿ƒè°ƒç”¨
        frame_cnt += 1
        if frame_cnt >= (env.motion_len - 1):
            break
    break
```

**5. visualize_motion æ–¹æ³•è¯¦è§£** (`legged_lab/envs/tienkung/tienkung_env.py:248-352`)

æ ¸å¿ƒå®ç°æ­¥éª¤:

**(1) è·å–æŒ‡å®šæ—¶é—´çš„åŠ¨ä½œå¸§** (248-262è¡Œ):
```python
visual_motion_frame = self.amp_loader_display.get_full_frame_at_time(0, time)
```
- `get_full_frame_at_time` æ–¹æ³•é€šè¿‡çº¿æ€§æ’å€¼è·å–ç²¾ç¡®æ—¶åˆ»çš„åŠ¨ä½œæ•°æ®
- æ•°æ®æ ¼å¼: `[root_pos(3), euler(3), dof_pos(26), root_lin_vel(3), ang_vel(3), dof_vel(26)]`

**(2) æ˜ å°„å…³èŠ‚æ•°æ®åˆ°æœºå™¨äºº** (265-276è¡Œ):
```python
dof_pos[:, self.left_leg_ids] = visual_motion_frame[6:12]    # å·¦è…¿ 6DOF
dof_pos[:, self.right_leg_ids] = visual_motion_frame[12:18]  # å³è…¿ 6DOF
dof_pos[:, self.left_arm_ids] = visual_motion_frame[18:22]   # å·¦è‡‚ 4DOF
dof_pos[:, self.right_arm_ids] = visual_motion_frame[22:26]  # å³è‡‚ 4DOF
# é€Ÿåº¦åŒç†æ˜ å°„
```

**(3) å†™å…¥æœºå™¨äººçŠ¶æ€** (278-302è¡Œ):
```python
# å†™å…¥å…³èŠ‚ä½ç½®å’Œé€Ÿåº¦
self.robot.write_joint_position_to_sim(dof_pos)
self.robot.write_joint_velocity_to_sim(dof_vel)

# å¤„ç† Root çŠ¶æ€ (ä½ç½®ã€å§¿æ€ã€é€Ÿåº¦)
root_pos = visual_motion_frame[:3].clone()
root_pos[2] += 0.3  # Zè½´åç§»

# Euler è§’è½¬å››å…ƒæ•°
euler = visual_motion_frame[3:6].cpu().numpy()
quat_xyzw = Rotation.from_euler("XYZ", euler, degrees=False).as_quat()
quat_wxyz = torch.tensor([quat_xyzw[3], quat_xyzw[0], quat_xyzw[1], quat_xyzw[2]], ...)

# æ„å»ºå®Œæ•´ root_state: [x,y,z, qw,qx,qy,qz, vx,vy,vz, wx,wy,wz]
self.robot.write_root_state_to_sim(root_state, env_ids)
```

**(4) ä»¿çœŸæ›´æ–°** (303-305è¡Œ):
```python
self.sim.render()
self.sim.step()
self.scene.update(dt=self.step_dt)
```

**(5) è®¡ç®—æœ«ç«¯æ‰§è¡Œå™¨ä½ç½®** (307-326è¡Œ):
```python
# è®¡ç®—å·¦å³æ‰‹ä½ç½® (ç›¸å¯¹ root çš„å±€éƒ¨åæ ‡)
left_hand_pos = self.robot.data.body_state_w[:, self.elbow_body_ids[0], :3] - ...
# è½¬æ¢åˆ° root å±€éƒ¨åæ ‡ç³»
left_hand_pos = quat_apply(quat_conjugate(self.robot.data.root_state_w[:, 3:7]), left_hand_pos)
# åŒç†è®¡ç®—è„šéƒ¨ä½ç½®
```

**(6) è¿”å›å®Œæ•´çŠ¶æ€** (336-352è¡Œ):
```python
return torch.cat((
    self.right_arm_dof_pos,   # å³è‡‚å…³èŠ‚ä½ç½®
    self.left_arm_dof_pos,    # å·¦è‡‚å…³èŠ‚ä½ç½®
    self.right_leg_dof_pos,   # å³è…¿å…³èŠ‚ä½ç½®
    self.left_leg_dof_pos,    # å·¦è…¿å…³èŠ‚ä½ç½®
    self.right_arm_dof_vel,   # é€Ÿåº¦åŒç†...
    self.left_arm_dof_vel,
    self.right_leg_dof_vel,
    self.left_leg_dof_vel,
    left_hand_pos,            # å·¦æ‰‹ä½ç½®
    right_hand_pos,           # å³æ‰‹ä½ç½®
    left_foot_pos,            # å·¦è„šä½ç½®
    right_foot_pos            # å³è„šä½ç½®
), dim=-1)
```

#### æœºå™¨äººé…ç½®æ–‡ä»¶

**1. ä¸»è¦é…ç½®æ–‡ä»¶è·¯å¾„**:

- **USD æ¨¡å‹æ–‡ä»¶**: `legged_lab/assets/tienkung2_lite/usd/tienkung2_lite.usd`
  - åœ¨ `legged_lab/assets/tienkung2_lite/tienkung.py:36` ä¸­å¼•ç”¨

- **å…³èŠ‚é…ç½®**: `legged_lab/assets/tienkung2_lite/tienkung.py:34-166`
  ```python
  TIENKUNG2LITE_CFG = ArticulationCfg(
      spawn=sim_utils.UsdFileCfg(
          usd_path=f"{ISAAC_ASSET_DIR}/tienkung2_lite/usd/tienkung2_lite.usd",
          ...
      ),
      init_state=ArticulationCfg.InitialStateCfg(
          pos=(0.0, 0.0, 1.0),
          joint_pos={...},  # åˆå§‹å…³èŠ‚ä½ç½®
          joint_vel={".*": 0.0},
      ),
      actuators={
          "legs": ImplicitActuatorCfg(...),   # è…¿éƒ¨æ‰§è¡Œå™¨é…ç½®
          "feet": ImplicitActuatorCfg(...),   # è„šéƒ¨æ‰§è¡Œå™¨é…ç½®
          "arms": ImplicitActuatorCfg(...),   # æ‰‹è‡‚æ‰§è¡Œå™¨é…ç½®
      },
  )
  ```

- **ç¯å¢ƒé…ç½®**: `legged_lab/envs/tienkung/walk_cfg.py:163-184`
  ```python
  class TienKungWalkFlatEnvCfg:
      amp_motion_files_display = ["legged_lab/envs/tienkung/datasets/motion_visualization/walk.txt"]
      scene: BaseSceneCfg = BaseSceneCfg(
          robot=TIENKUNG2LITE_CFG,  # ä½¿ç”¨ä¸Šè¿°æœºå™¨äººé…ç½®
          terrain_type="generator",
          ...
      )
  ```

**2. å…³èŠ‚ ID æ˜ å°„** (`legged_lab/envs/tienkung/tienkung_env.py:163-212`):

ç³»ç»Ÿåœ¨åˆå§‹åŒ–æ—¶é€šè¿‡ `find_joints` æ–¹æ³•è·å–å…³èŠ‚ç´¢å¼•:
```python
self.left_leg_ids, _ = self.robot.find_joints(
    name_keys=["hip_roll_l_joint", "hip_pitch_l_joint", "hip_yaw_l_joint",
               "knee_pitch_l_joint", "ankle_pitch_l_joint", "ankle_roll_l_joint"],
    preserve_order=True,
)
# åŒç†è·å– right_leg_ids, left_arm_ids, right_arm_ids, ankle_joint_ids ç­‰
```

**3. Body ID æ˜ å°„** (163-168è¡Œ):
```python
self.feet_body_ids, _ = self.robot.find_bodies(
    name_keys=["ankle_roll_l_link", "ankle_roll_r_link"],
    preserve_order=True
)
self.elbow_body_ids, _ = self.robot.find_bodies(
    name_keys=["elbow_pitch_l_link", "elbow_pitch_r_link"],
    preserve_order=True
)
```

#### æ•°æ®æµæ€»ç»“

```
1. TXTæ–‡ä»¶ (JSONæ ¼å¼)
   â†“ (AMPLoaderDisplay è¯»å–)
2. Torch Tensor [N_frames, 52]
   â†“ (get_full_frame_at_time æ’å€¼)
3. å•å¸§æ•°æ® [root(6) + dof_pos(26) + root_vel(6) + dof_vel(26)]
   â†“ (visualize_motion æ˜ å°„)
4. æœºå™¨äººçŠ¶æ€
   - dof_pos/vel â†’ æŒ‰ joint_ids æ˜ å°„åˆ°å…·ä½“å…³èŠ‚
   - root state â†’ å†™å…¥æœºå™¨äººæ ¹éƒ¨çŠ¶æ€
   â†“ (IsaacSim ä»¿çœŸ)
5. å¯è§†åŒ–æ˜¾ç¤º + æœ«ç«¯æ‰§è¡Œå™¨ä½ç½®è®¡ç®—
```

#### å…³é”®æ–‡ä»¶ä½ç½®æ±‡æ€»

- **å¯è§†åŒ–è„šæœ¬**: `legged_lab/scripts/play_amp_animation.py:54-118`
- **ç¯å¢ƒå®ç°**: `legged_lab/envs/tienkung/tienkung_env.py:248-352`
- **æ•°æ®åŠ è½½å™¨**: `rsl_rl/rsl_rl/utils/motion_loader_for_display.py:26-283`
- **æœºå™¨äººé…ç½®**: `legged_lab/assets/tienkung2_lite/tienkung.py:34-166`
- **ä»»åŠ¡é…ç½®**: `legged_lab/envs/tienkung/walk_cfg.py:163-184`
- **USD æ¨¡å‹**: `legged_lab/assets/tienkung2_lite/usd/tienkung2_lite.usd`

#### æ³¨æ„äº‹é¡¹

1. **åæ ‡ç³»è½¬æ¢**:
   - Root å§¿æ€ä½¿ç”¨æ¬§æ‹‰è§’ (XYZ) è½¬å››å…ƒæ•° (WXYZ)
   - æœ«ç«¯ä½ç½®ä»ä¸–ç•Œåæ ‡è½¬æ¢åˆ° Root å±€éƒ¨åæ ‡

2. **æ•°æ®æ ¼å¼è¦æ±‚**:
   - å¿…é¡»æ˜¯ JSON æ ¼å¼ TXT æ–‡ä»¶
   - åŒ…å« `FrameDuration`, `Frames` ç­‰å…³é”®å­—æ®µ
   - æ¯å¸§æ•°æ®è‡³å°‘ 52 ç»´ (26 pos + 26 vel)

3. **æœºå™¨äººé…ç½®ä¸€è‡´æ€§**:
   - USD æ–‡ä»¶å®šä¹‰ç‰©ç†æ¨¡å‹å’Œè§†è§‰å¤–è§‚
   - ArticulationCfg å®šä¹‰æ‰§è¡Œå™¨å‚æ•°
   - å…³èŠ‚é¡ºåºå¿…é¡»ä¸æ•°æ®æ–‡ä»¶åŒ¹é…

---

## 4. USD æ–‡ä»¶è¯¦è§£

### æé—®
usdæ–‡ä»¶æ˜¯ä»€ä¹ˆ

### å›ç­”

#### ğŸ“š åŸºæœ¬æ¦‚å¿µ

**USD** (Universal Scene Description,é€šç”¨åœºæ™¯æè¿°) æ˜¯ç”± **Pixar** å¼€å‘çš„ä¸€ç§å¼€æºæ¡†æ¶å’Œæ–‡ä»¶æ ¼å¼,ç”¨äºæè¿°ã€ç»„åˆå’Œæ¨¡æ‹Ÿå¤æ‚çš„ 3D åœºæ™¯ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**:
1. **é€šç”¨æ€§**: æè¿°å®Œæ•´çš„ 3D åœºæ™¯(å‡ ä½•ã€æè´¨ã€ç¯å…‰ã€ç›¸æœºã€åŠ¨ç”»ç­‰)
2. **å¯ç»„åˆæ€§**: æ”¯æŒåœºæ™¯åˆ†å±‚å’Œå¼•ç”¨,å¯å°†å¤šä¸ª USD æ–‡ä»¶ç»„åˆ
3. **é«˜æ€§èƒ½**: é’ˆå¯¹å¤§è§„æ¨¡åœºæ™¯ä¼˜åŒ–,æ”¯æŒå»¶è¿ŸåŠ è½½
4. **å¯æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹å’Œå±æ€§
5. **è¡Œä¸šæ ‡å‡†**: å¹¿æ³›åº”ç”¨äºç”µå½±ã€æ¸¸æˆã€æœºå™¨äººä»¿çœŸç­‰é¢†åŸŸ

#### ğŸ“ USD æ–‡ä»¶æ ¼å¼ç±»å‹

| æ‰©å±•å | æ ¼å¼ | ç‰¹ç‚¹ | ç”¨é€” |
|--------|------|------|------|
| `.usd` | é€šç”¨æ ¼å¼ | å¯ä»¥æ˜¯æ–‡æœ¬æˆ–äºŒè¿›åˆ¶ | ä¸€èˆ¬ç”¨é€” |
| `.usda` | ASCII æ–‡æœ¬ | äººç±»å¯è¯»,æ˜“äºç‰ˆæœ¬æ§åˆ¶ | è°ƒè¯•ã€æ‰‹åŠ¨ç¼–è¾‘ |
| `.usdc` | äºŒè¿›åˆ¶ Crate | ç´§å‡‘é«˜æ•ˆ,åŠ è½½å¿« | ç”Ÿäº§ç¯å¢ƒ |
| `.usdz` | å‹ç¼©åŒ… | åŒ…å«æ‰€æœ‰ä¾èµ–èµ„æº | åˆ†å‘ã€AR åº”ç”¨ |

åœ¨æœ¬é¡¹ç›®ä¸­,ä½¿ç”¨çš„æ˜¯ **`.usd` æ ¼å¼**(å®é™…ä¸ºäºŒè¿›åˆ¶ USD crate 0.8.0 ç‰ˆæœ¬):
```bash
$ file tienkung2_lite.usd
tienkung2_lite.usd: USD crate, version 0.8.0
```

#### ğŸ¤– åœ¨æœºå™¨äººä»¿çœŸä¸­çš„åº”ç”¨

USD æ–‡ä»¶åœ¨ IsaacSim/IsaacLab ä¸­å®šä¹‰å®Œæ•´çš„æœºå™¨äººæ¨¡å‹:

**1. å‡ ä½•ç»“æ„**:
- Links/Bodies: æœºå™¨äººçš„åˆšä½“éƒ¨ä»¶
- ç½‘æ ¼æ–‡ä»¶å¼•ç”¨: STLã€OBJ ç­‰æ ¼å¼çš„ 3D æ¨¡å‹
- è§†è§‰å¤–è§‚: æè´¨ã€çº¹ç†ã€é¢œè‰²

**2. ç‰©ç†å±æ€§**:
- è´¨é‡ (Mass)
- æƒ¯æ€§çŸ©é˜µ (Inertia)
- ç¢°æ’ä½“ (Colliders): å‡¸åŒ…ã€ç½‘æ ¼ã€åŸºæœ¬å½¢çŠ¶
- æ‘©æ“¦ç³»æ•°ã€æ¢å¤ç³»æ•°

**3. å…³èŠ‚å®šä¹‰**:
- å…³èŠ‚ç±»å‹: Revolute(æ—‹è½¬)ã€Prismatic(å¹³ç§»)ã€Fixed(å›ºå®š)
- å…³èŠ‚è½´å‘
- å…³èŠ‚é™åˆ¶ (ä½ç½®ã€é€Ÿåº¦ã€åŠ›çŸ©)
- é©±åŠ¨å‚æ•° (åˆšåº¦ã€é˜»å°¼)

**4. ä¼ æ„Ÿå™¨ä¸é™„ä»¶**:
- ç›¸æœº (RGBã€æ·±åº¦ã€åˆ†å‰²)
- æ¿€å…‰é›·è¾¾
- IMUã€æ¥è§¦ä¼ æ„Ÿå™¨ç­‰

#### ğŸ”„ ä¸å…¶ä»–æ ¼å¼çš„å¯¹æ¯”

| æ ¼å¼ | å¼€å‘è€… | ä¸»è¦ç”¨é€” | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|--------|---------|------|------|
| **URDF** | ROS ç¤¾åŒº | ROS æœºå™¨äºº | ç®€å•æ˜“ç”¨,ROS ç”Ÿæ€ | åŠŸèƒ½æœ‰é™,ä¸æ”¯æŒå¤æ‚åœºæ™¯ |
| **MJCF/XML** | DeepMind | MuJoCo ä»¿çœŸ | ç‰©ç†ä»¿çœŸç²¾ç¡® | ä¸“ç”¨æ ¼å¼,ä¸é€šç”¨ |
| **USD** | Pixar | é€šç”¨åœºæ™¯æè¿° | åŠŸèƒ½å¼ºå¤§,è¡Œä¸šæ ‡å‡† | å­¦ä¹ æ›²çº¿è¾ƒé™¡ |
| **SDF** | OSRF | Gazebo ä»¿çœŸ | ç±»ä¼¼ URDF,åŠŸèƒ½æ›´å¼º | ä¸»è¦é™äº Gazebo |

#### ğŸ“‚ åœ¨ TienKung-Lab é¡¹ç›®ä¸­çš„ä½¿ç”¨

**é¡¹ç›®ä¸­çš„ USD æ–‡ä»¶ç»“æ„**:
```
legged_lab/assets/tienkung2_lite/
â”œâ”€â”€ usd/
â”‚   â”œâ”€â”€ tienkung2_lite.usd              # ä¸» USD æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml                      # USD è½¬æ¢é…ç½®
â”‚   â”œâ”€â”€ configuration/
â”‚   â”‚   â”œâ”€â”€ tienkung2_lite_base.usd     # åŸºç¡€å‡ ä½•å’Œç‰©ç†
â”‚   â”‚   â”œâ”€â”€ tienkung2_lite_physics.usd  # ç‰©ç†å±æ€§
â”‚   â”‚   â””â”€â”€ tienkung2_lite_sensor.usd   # ä¼ æ„Ÿå™¨é…ç½®
â”‚   â””â”€â”€ .asset_hash                      # èµ„äº§å“ˆå¸Œå€¼
â”œâ”€â”€ urdf/
â”‚   â””â”€â”€ tienkung2_lite.urdf             # æº URDF æ–‡ä»¶
â”œâ”€â”€ mjcf/
â”‚   â””â”€â”€ tienkung.xml                     # MuJoCo XML (ç”¨äº Sim2Sim)
â”œâ”€â”€ meshes/                              # 3D ç½‘æ ¼æ–‡ä»¶
â”‚   â”œâ”€â”€ pelvis.STL
â”‚   â”œâ”€â”€ hip_roll_l_link.STL
â”‚   â”œâ”€â”€ knee_pitch_l_link.STL
â”‚   â””â”€â”€ ... (å…¶ä»– STL æ–‡ä»¶)
â””â”€â”€ tienkung.py                          # IsaacLab é…ç½®æ–‡ä»¶
```

**USD æ–‡ä»¶çš„å±‚æ¬¡ç»“æ„**:

ä¸»æ–‡ä»¶ `tienkung2_lite.usd` é€šè¿‡ **subLayers** å¼•ç”¨å…¶ä»–é…ç½®æ–‡ä»¶:
```
tienkung2_lite.usd
â”œâ”€â”€ configuration/tienkung2_lite_base.usd     (å‡ ä½•å’Œç»“æ„)
â”œâ”€â”€ configuration/tienkung2_lite_physics.usd  (ç‰©ç†å±æ€§)
â””â”€â”€ configuration/tienkung2_lite_sensor.usd   (ä¼ æ„Ÿå™¨)
```

è¿™ç§åˆ†å±‚è®¾è®¡çš„ä¼˜åŠ¿:
- **æ¨¡å—åŒ–**: ä¸åŒé…ç½®åˆ†ç¦»,æ˜“äºç»´æŠ¤
- **å¯å¤ç”¨**: å¯åœ¨ä¸åŒåœºæ™¯ä¸­å¤ç”¨åŸºç¡€æ¨¡å‹
- **ç‰ˆæœ¬æ§åˆ¶**: å¯å•ç‹¬ä¿®æ”¹ç‰©ç†æˆ–ä¼ æ„Ÿå™¨é…ç½®

#### ğŸ”§ USD æ–‡ä»¶çš„ç”Ÿæˆ

åœ¨æœ¬é¡¹ç›®ä¸­,USD æ–‡ä»¶æ˜¯ä» URDF è½¬æ¢è€Œæ¥,é…ç½®æ–‡ä»¶ `config.yaml` è®°å½•äº†è½¬æ¢å‚æ•°:

```yaml
# æºæ–‡ä»¶
asset_path: /legged_lab/assets/tienkung2_lite/urdf/tienkung2_lite.urdf

# è¾“å‡ºé…ç½®
usd_dir: /legged_lab/assets/tienkung2_lite/usd
usd_file_name: tienkung2_lite.usd
force_usd_conversion: true

# è½¬æ¢é€‰é¡¹
make_instanceable: true          # ä½¿æ¨¡å‹å¯å®ä¾‹åŒ–(å¤šç¯å¢ƒå¤ç”¨)
fix_base: false                  # ä¸å›ºå®šåŸºåº§(äººå½¢æœºå™¨äººéœ€è¦è‡ªç”±ç§»åŠ¨)
merge_fixed_joints: true         # åˆå¹¶å›ºå®šå…³èŠ‚
link_density: 0.0                # é“¾æ¥å¯†åº¦(0è¡¨ç¤ºä½¿ç”¨URDFä¸­çš„è´¨é‡)

# å…³èŠ‚é©±åŠ¨é…ç½®
joint_drive:
  drive_type: force              # åŠ›æ§åˆ¶
  target_type: none              # æ— é»˜è®¤ç›®æ ‡
  gains:
    stiffness: 0.0               # åˆšåº¦(åœ¨Pythoné…ç½®ä¸­å•ç‹¬è®¾ç½®)
    damping: 0.0                 # é˜»å°¼(åœ¨Pythoné…ç½®ä¸­å•ç‹¬è®¾ç½®)

# ç¢°æ’é…ç½®
collider_type: convex_hull       # ä½¿ç”¨å‡¸åŒ…ä½œä¸ºç¢°æ’ä½“
self_collision: false            # ç¦ç”¨è‡ªç¢°æ’
collision_from_visuals: false    # ä¸ä»è§†è§‰ç½‘æ ¼ç”Ÿæˆç¢°æ’ä½“
replace_cylinders_with_capsules: false
```

**è½¬æ¢å·¥å…·**: IsaacSim æä¾›çš„ URDF Importer (åœ¨é…ç½®ä¸­è®°å½•ä¸º `UrdfConverter`)

#### ğŸ® USD æ–‡ä»¶åœ¨ä»£ç ä¸­çš„ä½¿ç”¨

åœ¨ `legged_lab/assets/tienkung2_lite/tienkung.py:34-50`:

```python
TIENKUNG2LITE_CFG = ArticulationCfg(
    spawn=sim_utils.UsdFileCfg(
        usd_path=f"{ISAAC_ASSET_DIR}/tienkung2_lite/usd/tienkung2_lite.usd",
        activate_contact_sensors=True,
        rigid_props=sim_utils.RigidBodyPropertiesCfg(
            disable_gravity=False,
            max_linear_velocity=1000.0,
            max_angular_velocity=1000.0,
            ...
        ),
        articulation_props=sim_utils.ArticulationRootPropertiesCfg(
            enabled_self_collisions=False,
            solver_position_iteration_count=8,
            solver_velocity_iteration_count=4
        ),
    ),
    ...
)
```

**å…³é”®å‚æ•°è¯´æ˜**:
- `usd_path`: USD æ–‡ä»¶è·¯å¾„
- `activate_contact_sensors`: æ¿€æ´»æ¥è§¦ä¼ æ„Ÿå™¨
- `rigid_props`: åˆšä½“ç‰©ç†å±æ€§(é‡åŠ›ã€é€Ÿåº¦é™åˆ¶ç­‰)
- `articulation_props`: å…³èŠ‚æ ‘å±æ€§(ç¢°æ’ã€æ±‚è§£å™¨è¿­ä»£æ¬¡æ•°)

#### ğŸ” æŸ¥çœ‹å’Œç¼–è¾‘ USD æ–‡ä»¶

**1. ä½¿ç”¨ USD å·¥å…·**:
```bash
# æŸ¥çœ‹ USD æ–‡ä»¶ä¿¡æ¯
usdcat tienkung2_lite.usd

# è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
usdcat tienkung2_lite.usd -o tienkung2_lite.usda

# æŸ¥çœ‹ USD å±‚æ¬¡ç»“æ„
usdtree tienkung2_lite.usd
```

**2. ä½¿ç”¨ IsaacSim**:
- åœ¨ IsaacSim GUI ä¸­ç›´æ¥æ‰“å¼€ USD æ–‡ä»¶
- å¯è§†åŒ–æŸ¥çœ‹æœºå™¨äººæ¨¡å‹
- æ£€æŸ¥å…³èŠ‚ã€ç¢°æ’ä½“ã€ç‰©ç†å±æ€§

**3. ä½¿ç”¨ USD Composer (åŸ Omniverse Create)**:
- Nvidia æä¾›çš„ USD ç¼–è¾‘å™¨
- å¯è§†åŒ–ç¼–è¾‘åœºæ™¯ã€æè´¨ã€ç‰©ç†å±æ€§

#### ğŸŒŸ USD çš„ä¼˜åŠ¿æ€»ç»“

åœ¨æœºå™¨äººä»¿çœŸä¸­ä½¿ç”¨ USD çš„ä¼˜åŠ¿:

1. **ç»Ÿä¸€æ ‡å‡†**: Pixarã€Nvidiaã€Apple ç­‰å…¬å¸å…±åŒæ”¯æŒ
2. **é«˜æ€§èƒ½**: é’ˆå¯¹å¤§è§„æ¨¡åœºæ™¯ä¼˜åŒ–,æ”¯æŒ GPU åŠ é€Ÿ
3. **åœºæ™¯ç»„åˆ**: å¯ä»¥è½»æ¾ç»„åˆå¤šä¸ªæœºå™¨äººã€ç¯å¢ƒã€é“å…·
4. **ç‰©ç†ä»¿çœŸ**: ä¸ PhysX ç­‰ç‰©ç†å¼•æ“æ·±åº¦é›†æˆ
5. **å®æ—¶æ¸²æŸ“**: æ”¯æŒå…‰çº¿è¿½è¸ªã€å®æ—¶æ¸²æŸ“
6. **æ•°æ®ç®¡é“**: é€‚åˆä»è®¾è®¡åˆ°ä»¿çœŸå†åˆ°éƒ¨ç½²çš„å®Œæ•´æµç¨‹

#### ç›¸å…³èµ„æº

- **USD å®˜æ–¹æ–‡æ¡£**: https://openusd.org/
- **IsaacSim USD æ–‡æ¡£**: https://docs.omniverse.nvidia.com/isaacsim/latest/
- **USD Python API**: `pxr` åŒ… (Pixar USD Python ç»‘å®š)
- **è½¬æ¢å·¥å…·**: IsaacSim URDF Importer, USD Composer

#### å…³é”®æ–‡ä»¶ä½ç½®

- **ä¸» USD æ–‡ä»¶**: `legged_lab/assets/tienkung2_lite/usd/tienkung2_lite.usd`
- **è½¬æ¢é…ç½®**: `legged_lab/assets/tienkung2_lite/usd/config.yaml`
- **Python é…ç½®**: `legged_lab/assets/tienkung2_lite/tienkung.py:36`
- **æº URDF**: `legged_lab/assets/tienkung2_lite/urdf/tienkung2_lite.urdf`
- **ç½‘æ ¼æ–‡ä»¶**: `legged_lab/assets/tienkung2_lite/meshes/*.STL`
